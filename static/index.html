<!DOCTYPE html>
<html lang=en>
<title>FYT Bus Packet Generator</title>
<meta charset="UTF-8">
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/ui-stylesheet.css">

<header>
<h1>FYT Bus Packet Generator</h1>
<ul>
<li><a href="/">Home</a></li>
<li><a href="/packets">Packets</a></li>
</ul>
</header>

<main>
<h2>Generate new packet</h2>
<form action="/api/packet" method=post>
<fieldset name=trip-info>
<legend>Trip info</legend>
<label>Trip name: <input type=text name=trip-name required></label>
<label>Trip date: <input type=date name=trip-date id=trip-date required></label>
</fieldset>

<fieldset name=route-start>
<legend>Trip start</legend>
<label for=origin-location>Start location: </label>
<select id=origin-location name=origin-location required>
	<option value="" selected disabled hidden>---- Choose a location ----
</select>
<button class=nodisplay onclick="this.parentElement.remove()" type=button>Remove</button>
</fieldset>

<button id=add type=button onclick="addNewWaypoint()">
Insert another trip stop
</button>

<fieldset name=route-end>
<legend>Trip end</legend>
<label for=destination-location>End location: </label>
<select id=destination-location name=destination-location required>
	<option value="" selected disabled hidden>---- Choose a location ----
</select>
</fieldset>

<button type=submit>Submit</button>
</form>

<h2>Existing packets</h2>
<ul id=packets-list>
</ul>

</main>

<script>
	// Default trip date to today
	document.getElementById('trip-date').valueAsDate = new Date()
	const INITIAL_FIELDSETS = document.querySelectorAll('fieldset').length

	// Populate "stops" options with the stops from the backend
	fetch('/api/stops').then(res => res.text()).then(text => {
			document.getElementById('origin-location').innerHTML += text
			document.getElementById('destination-location').innerHTML += text
		})

	// Populate existing packets from the backend, then enable page
	fetch('/api/packet').then(res => res.text()).then(text => {
			document.getElementById('packets-list').innerHTML += text
		})

	function deletePacket (name) {
			fetch(`/api/packet/${name}`, { method: 'DELETE' })
				.then(res => location.reload())
				.catch(err => console.log('Failed to delete packet'))
		}

	function addNewWaypoint () {
			const form = document.querySelector('form')
			const { add, ['route-start']: start } = form
			const newFieldset = start.cloneNode(true)
			const num = document.querySelectorAll('fieldset').length - INITIAL_FIELDSETS + 1
			const deleteButton = document.createElement

			newFieldset.setAttribute('name', `stop${num}`)
			newFieldset.children[0].innerHTML = `Stop ${num}`
			newFieldset.children[1].setAttribute('for', `stop${num}-location`)
			newFieldset.children[1].attributes.innerHTML = 'Stop location:'
			newFieldset.children[2].setAttribute('id', `stop${num}-location`)
			newFieldset.children[2].setAttribute('name', `stop${num}-location`)
			newFieldset.children[3].classList.remove('nodisplay')

			form.insertBefore(newFieldset, add)
		}

</script>
