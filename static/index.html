<!DOCTYPE html>
<html lang=en>
<title>FYT Bus Packet Generator</title>
<meta charset="UTF-8">
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/ui-stylesheet.css">

<header>
<h1>FYT Bus Packet Generator</h1>
<ul>
<li><a href="/">Home</a>
<li><a href="/packets">Packets</a>
<li><a href="/trips">Trips</a></li>
</ul>
</header>

<main>
<h2>Generate new packet</h2>
<form action="/api/packets" method=post>

<fieldset name=bus-info>
<legend>Bus info</legend>
<label>Bus trip name: <input type=text name=trip-name placeholder="Leave blank for default name"></label>
<label>Bus trip date: <input type=date name=trip-date id=trip-date required></label>
<script>document.getElementById('trip-date').valueAsDate = new Date()</script>
</fieldset>

<fieldset name=route-start>
<legend>Route start</legend>
<label>Start location:
<select class="location" name=origin-location required>
	<option value="" selected disabled hidden>---- Choose a location ----
</select>
</label>
<button class="delete nodisplay" onclick="this.parentElement.remove()" type=button>Remove</button>
</fieldset>

<button id=add type=button onclick="addNewWaypoint()">
&#10133; Insert another trip stop
</button>

<fieldset name=route-end>
<legend>Route end</legend>
<label>End location:
<select class="location" name=destination-location required>
	<option value="" selected disabled hidden>---- Choose a location ----
</select>
</label>
</fieldset>

<button type=button onclick="setTripBoardingOptions()">Update stops</button>
<fieldset name=trip-boardings>
<legend>Trip boardings</legend>

<span>J62</span>
<select class="trip-stop start" name=trip-j62-start></select>
<select class="trip-stop end" name=trip-j62-end></select>

<hr>

<span>J174</span>
<select class="trip-stop start" name=trip-j174-start></select>
<select class="trip-stop end" name=trip-j174-end></select>

</fieldset>

<button type=submit>Submit</button>
</form>

<h2>Existing packets</h2>
<ul id=packets-list>
</ul>

</main>

<script>
const INITIAL_FIELDSETS = document.querySelectorAll('fieldset').length
const WINDOW_URL = new URL(window.location.href)

function addNewWaypoint () {
		const form = document.querySelector('form')
		const { add, ['route-start']: start } = form
		const newFieldset = start.cloneNode(true)
		const num = document.querySelectorAll('fieldset').length - INITIAL_FIELDSETS + 1

		newFieldset.setAttribute('name', `stop${num}`)
		const [ legend, label, deleteButton ] = newFieldset.children

		legend.innerHTML = `Stop ${num}`
		label.attributes.innerHTML = 'Stop location:'
		label.children[0].setAttribute('name', `stop${num}-location`)
		deleteButton.classList.remove('nodisplay')

		form.insertBefore(newFieldset, add)
	}

function setTripBoardingOptions () {
		// Available boarding options are the currently selected bust stops
		const currentStops = Array
			.from(document.querySelectorAll('.location'))
			.map(item => item.value)

		const options = currentStops
			.map((item) => (`<option>${item}`))
			.join('\n')

		const tripStops = document
			.querySelectorAll('.trip-stop')
			.forEach((item) => {
					const currentSelection = item.value
					const defaultIndex = item.classList.contains('start') ? 0 : currentStops.length -1
					item.innerHTML = options
					item.options.selectedIndex = currentStops.includes(currentSelection)
						? currentStops.indexOf(currentSelection)
						: defaultIndex
				})
	}



// Populate "stops" options with the stops from the backend
fetch('/api/stops').then(res => res.text()).then(text => {
		document.getElementsByName('origin-location')[0].innerHTML += text
		document.getElementsByName('destination-location')[0].innerHTML += text

		// Pre-populate form if there's a query in the window
		const params = Array.from(WINDOW_URL.searchParams.entries())
		params.filter(item => item[0].includes('stop')).forEach(addNewWaypoint)
		params.forEach(([key, value]) => document.getElementsByName(key)[0].value = value)
	})

// Populate existing packets from the backend, then enable page
fetch('/api/packets').then(res => res.text()).then(text => {
		document.getElementById('packets-list').innerHTML += text
	})

async function editPacket (name) {
		const res = await fetch(`/api/packets/${name}?queryOnly`, { method: 'GET' })
		const queryString = await res.text()
		location.assign(`${WINDOW_URL.origin}?${queryString}`)
	}

// Though not in HTML source, packets populated via AJAX use this function to delete themselves
async function deletePacket (name) {
		if (!window.confirm('Are you sure you want to delete?')) return

		fetch(`/api/packets/${name}`, { method: 'DELETE' })
			.then(() => location.reload())
			.catch(() => alert('Something went wrong trying to delete the packet.'))
	}
</script>
